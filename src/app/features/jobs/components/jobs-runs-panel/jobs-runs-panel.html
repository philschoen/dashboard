<mat-card class="runs-card">

  <!-- Header -->
  <div class="runs-header">
    <div class="runs-header-left">
      <div class="runs-title">Job-Historie</div>
      <div class="runs-sub">
        {{ total }} Einträge · Seite {{ pageIndex + 1 }}
      </div>
    </div>

    <div class="runs-header-actions">
      <button mat-stroked-button (click)="resetFilters.emit()">
        Reset
      </button>
    </div>
  </div>

  <!-- Overview bleibt, aber etwas eingerahmt -->
  <div class="overview-shell">
    <app-jobs-overview
      [total]="totalJobs"
      [running]="running"
      [queued]="pending"
      [succeeded]="succeeded"
      [failed]="failed"
      [cancelled]="cancelled"
      (filterByStatus)="filterByStatus.emit($event)">
    </app-jobs-overview>
  </div>

  <!-- Filters -->
  <div class="filters-shell">
    <div class="filters-grid">
      <mat-form-field appearance="outline">
        <mat-label>Queue</mat-label>
        <mat-select [value]="selectedQueue" (selectionChange)="queueChange.emit($event.value)">
          <mat-option [value]="null">Alle</mat-option>
          @for (q of queues; track q) {
            <mat-option [value]="q">{{ q }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Type</mat-label>
        <mat-select [value]="selectedType" (selectionChange)="typeChange.emit($event.value)">
          <mat-option [value]="null">Alle</mat-option>
          @for (t of types; track t) {
            <mat-option [value]="t">{{ t }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Status</mat-label>
        <mat-select multiple [value]="selectedStatuses" (selectionChange)="statusesChange.emit($event.value)">
          <mat-option value="Pending">Pending</mat-option>
          <mat-option value="Running">Running</mat-option>
          <mat-option value="Succeeded">Succeeded</mat-option>
          <mat-option value="Failed">Failed</mat-option>
          <mat-option value="Cancelled">Cancelled</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="search">
        <mat-label>Search</mat-label>
        <input
          matInput
          [value]="searchQuery"
          (input)="searchChange.emit($event.target.value)"
          placeholder="Name, Type, Queue…">
      </mat-form-field>
    </div>

    <div class="filters-hint">
      Tipp: Klick auf einen Run öffnet die Details rechts.
    </div>
  </div>

  <!-- Table -->
  @if (runs.length === 0) {
    <div class="empty">
      <div class="empty-title">Keine Job-Runs gefunden</div>
      <div class="empty-sub">Passe Filter oder Suche an.</div>
    </div>
  } @else {
    <div class="table-shell">
      <table mat-table [dataSource]="runs" class="runs-table">

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let run">
            <mat-chip [class]="chipClassForStatus?.(run.status)">{{ run.status }}</mat-chip>
          </td>
        </ng-container>

        <ng-container matColumnDef="job">
          <th mat-header-cell *matHeaderCellDef>Job</th>
          <td mat-cell *matCellDef="let run" >{{ run.jobKey }}</td>
        </ng-container>

        <ng-container matColumnDef="target">
          <th mat-header-cell *matHeaderCellDef>Ziel</th>
          <td mat-cell *matCellDef="let run">{{ run.targetId }}</td>
        </ng-container>

        <ng-container matColumnDef="requestedAt">
          <th mat-header-cell *matHeaderCellDef>Start</th>
          <td mat-cell *matCellDef="let run">
            {{ run.requestedAt | date:'short' }}
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="columns" class="sticky-header"></tr>

        <tr mat-row
            *matRowDef="let row; columns: columns"
            class="row"
            [class.selected]="row.id === selectedRunId"
            (click)="openRun.emit(row.id)">
        </tr>
      </table>
    </div>
  }

  <!-- Paginator -->
  <div class="paginator-shell">
    <mat-paginator
      [length]="total"
      [pageSize]="pageSize"
      [pageIndex]="pageIndex"
      [pageSizeOptions]="[10,25,50]"
      (page)="pageChange.emit($event)">
    </mat-paginator>
  </div>

</mat-card>