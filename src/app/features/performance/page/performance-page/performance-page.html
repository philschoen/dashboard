<div class="page">
    <div class="header">
        <h2>Performance</h2>
        
        <div class="controls">
            <mat-form-field appearance="outline" class="service-select">
                <mat-label>Service</mat-label>
                <mat-select [value]="serviceId()" (selectionChange)="setService($event)">
                    @for(svc of services; track svc.id){
                    <mat-option [value]="svc.id">{{ svc.name }}</mat-option>
                    }
                </mat-select>
            </mat-form-field>

            <mat-button-toggle-group [value]="range()" (change)="setRange($event)">
                <mat-button-toggle value="15m">15m</mat-button-toggle>
                <mat-button-toggle value="1h">1h</mat-button-toggle>
                <mat-button-toggle value="24h">24h</mat-button-toggle>
            </mat-button-toggle-group>
        </div>
    </div>
    

    <mat-tab-group (selectedIndexChange)="setTabByIndex($event)">
        @for(t of tabs; track t.key){
        <mat-tab [label]="t.label">

            @let vmData = vm();
            @if(vmData.tab === t.key){

            <!-- KPIs -->
            <div class="kpi-grid">
                @if(vmData.summaryState.kind === 'ok'){
                @for(k of vmData.tabCfg.kpis; track k){
                @let metric = getMetric(vmData.summaryState.data, k);
                <app-metric-kpi-card 
                    [title]="metricTitle(k)"
                    [value]="metric?.value ?? 0"
                    [unit]="metric?.unit ?? metricUnitLabel(k)"
                    [status]="metric?.status ?? 'ok'">
                </app-metric-kpi-card>
                }
                } @else if(vmData.summaryState.kind === 'loading'){
                <p>Loading KPIs...</p>
                } @else {
                <p>Error loading KPIs</p>
                }
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <app-time-series-chart 
                    [title]="metricTitle(vmData.tabCfg.line.key)"
                    [unitLabel]="metricUnitLabel(vmData.tabCfg.line.key)" 
                    [state]="vmData.lineState">
                </app-time-series-chart>

                <app-top-services-bar-chart 
                    [title]="'Top Services â€“ ' + metricTitle(vmData.tabCfg.top.key)"
                    [unitLabel]="metricUnitLabel(vmData.tabCfg.top.key)" 
                    [state]="vmData.topState">
                </app-top-services-bar-chart>
            </div>

            }
        </mat-tab>
        }
    </mat-tab-group>
</div>